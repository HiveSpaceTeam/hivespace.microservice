name: API Gateway CI

on:
  push:
    paths:
      - 'infra/api-gateway.bicep'
      - 'infra/parameters/api-gateway-dev.json'
      - '.github/workflows/api-gateway-ci.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_SERVICE }}

      - name: Fetch Backend URLs and Secrets
        id: fetch-resources
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Fetching backend service URLs..."

            # 1. User Service (Container App)
            if az containerapp show \
              --name ${{ vars.AZURE_CONTAINER_APP_USER_SERVICE_NAME }} \
              --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
              --query properties.configuration.ingress.fqdn \
              --output tsv &>/dev/null; then
              
                USER_SERVICE_FQDN=$(az containerapp show \
                  --name ${{ vars.AZURE_CONTAINER_APP_USER_SERVICE_NAME }} \
                  --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
                  --query properties.configuration.ingress.fqdn \
                  --output tsv)
                echo "✓ User Service found: https://$USER_SERVICE_FQDN"
            else
                echo "⚠️ User Service not found. Using placeholder."
                USER_SERVICE_FQDN="user-service-not-deployed.azurecontainerapps.io"
            fi

            # Validate that USER_SERVICE_FQDN is not empty
            if [ -z "$USER_SERVICE_FQDN" ]; then
              echo "ERROR: USER_SERVICE_FQDN is empty!"
              USER_SERVICE_FQDN="user-service-not-deployed.azurecontainerapps.io"
            fi

            # 2. Catalog Service (App Service)
            if az webapp show \
              --name ${{ vars.AZURE_WEBAPP_CATALOG_SERVICE_NAME }} \
              --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
              --query defaultHostName \
              --output tsv &>/dev/null; then

                CATALOG_SERVICE_HOST=$(az webapp show \
                  --name ${{ vars.AZURE_WEBAPP_CATALOG_SERVICE_NAME }} \
                  --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
                  --query defaultHostName \
                  --output tsv)
                echo "✓ Catalog Service found: https://$CATALOG_SERVICE_HOST"
            else
                echo "⚠️ Catalog Service not found. Using placeholder."
                CATALOG_SERVICE_HOST="catalog-service-not-deployed.azurewebsites.net"
            fi

            # Validate that CATALOG_SERVICE_HOST is not empty
            if [ -z "$CATALOG_SERVICE_HOST" ]; then
              echo "ERROR: CATALOG_SERVICE_HOST is empty!"
              CATALOG_SERVICE_HOST="catalog-service-not-deployed.azurewebsites.net"
            fi

            # 3. Media Service (Function App)
            # Use 'func-hivespace-media-svc-dev' as fallback if var not set
            MEDIA_APP_NAME="${{ vars.AZURE_FUNCTION_APP_MEDIA_SERVICE_NAME }}"
            if [ -z "$MEDIA_APP_NAME" ]; then
              MEDIA_APP_NAME="func-hivespace-media-svc-dev"
            fi

            echo "Looking for Media Service Function App: $MEDIA_APP_NAME"

            # For Flex Consumption function apps, defaultHostName is null
            # Use hostNameSslStates[0].name instead
            if az functionapp show \
              --name "$MEDIA_APP_NAME" \
              --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
              --output tsv &>/dev/null; then
                
                MEDIA_SERVICE_HOST=$(az functionapp show \
                  --name "$MEDIA_APP_NAME" \
                  --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
                  --query "properties.hostNameSslStates[?hostType=='Standard'].name | [0]" \
                  --output tsv)
                
                if [ -n "$MEDIA_SERVICE_HOST" ]; then
                  echo "✓ Media Service found: https://$MEDIA_SERVICE_HOST"
                else
                  echo "⚠️ Could not retrieve hostname. Using placeholder."
                  MEDIA_SERVICE_HOST="media-service-not-deployed.azurewebsites.net"
                fi
            else
                echo "⚠️ Media Service ($MEDIA_APP_NAME) not found. Using placeholder."
                MEDIA_SERVICE_HOST="media-service-not-deployed.azurewebsites.net"
            fi

            # Validate that MEDIA_SERVICE_HOST is not empty
            if [ -z "$MEDIA_SERVICE_HOST" ]; then
              echo "ERROR: MEDIA_SERVICE_HOST is empty!"
              MEDIA_SERVICE_HOST="media-service-not-deployed.azurewebsites.net"
            fi

            # 4. App Insights Resources
            # Install application-insights extension if not already installed
            echo "Installing Application Insights extension..."
            az extension add --name application-insights --only-show-errors 2>/dev/null || true

            # Set Outputs
            echo "user_url=https://$USER_SERVICE_FQDN" >> $GITHUB_OUTPUT
            echo "catalog_url=https://$CATALOG_SERVICE_HOST" >> $GITHUB_OUTPUT
            echo "media_url=https://$MEDIA_SERVICE_HOST" >> $GITHUB_OUTPUT

      - name: Deploy API Gateway via Bicep
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Deploying API Management Configuration..."

            # KeyVault Secret for Custom Domain
            KV_NAME="${{ vars.KEY_VAULT_NAME }}"
            CERT_SECRET_NAME="${{ vars.CERT_SECRET_NAME }}"

            echo "Checking for Key Vault: $KV_NAME"
            if ! az keyvault show --name "$KV_NAME" --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} &>/dev/null; then
              echo "❌ Error: Key Vault '$KV_NAME' not found!"
              exit 1
            fi

            echo "Checking for Certificate Secret: $CERT_SECRET_NAME"
            # Get latest secret version ID to constructing versioned URL
            CERT_ID=$(az keyvault secret show --vault-name "$KV_NAME" --name "$CERT_SECRET_NAME" --query "id" --output tsv)
            CERT_VERSION=${CERT_ID##*/}

            if [ -z "$CERT_VERSION" ]; then
              echo "❌ Error: Secret '$CERT_SECRET_NAME' not found in Key Vault '$KV_NAME'!"
              exit 1
            fi

            # Construct versioned secret URL: https://{vault}.vault.azure.net/secrets/{name}/{version}
            CERT_SECRET_URL="https://$KV_NAME.vault.azure.net/secrets/$CERT_SECRET_NAME/$CERT_VERSION"
            echo "✓ Found certificate secret. URL constructed."

            az deployment group create \
              --name api-gateway-deploy \
              --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
              --template-file infra/api-gateway.bicep \
              --parameters infra/parameters/api-gateway-dev.json \
              --parameters \
                userServiceUrl="${{ steps.fetch-resources.outputs.user_url }}" \
                catalogServiceUrl="${{ steps.fetch-resources.outputs.catalog_url }}" \
                mediaServiceUrl="${{ steps.fetch-resources.outputs.media_url }}" \
                customDomainCertificateUrl="$CERT_SECRET_URL" \
                customDomainHostName="${{ vars.API_GATEWAY_CUSTOM_DOMAIN }}"
